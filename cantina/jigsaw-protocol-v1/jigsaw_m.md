
------------------------------------------------------------------------------------
File 12                                blank        comment           code
------------------------------------------------------------------------------------
Holding.sol                               22            112             66

Manager.sol                               85            509            259
HoldingManager.sol                        60            300            255
StablesManager.sol                        57            267            169
SharesRegistry.sol                        46            238            154
JigsawUSD.sol                             15             77             48
StrategyManager.sol                       56            257            302

ReceiptToken.sol                          14             79             42
ReceiptTokenFactory.sol                   14             38             48

LiquidationManager.sol                    72            257            311
SwapManager.sol                           30            109            113

Staker.sol                                46            131            152
------------------------------------------------------------------------------------
SUM:                                     517           2374           1919
------------------------------------------------------------------------------------


┌─────────────────┐      ┌───────────────────┐      ┌─────────────────┐
│  Liquidation    │◄────►│    SwapManager    │◄────►│   Uniswap V3    │
│    Manager      │      │                   │      │    Router       │
└────────┬────────┘      └───────────────────┘      └─────────────────┘
         │
         │  ┌───────────────────┐      ┌─────────────────┐
         └─►│    StablesManager │◄────►│    JigsawUSD    │
            └────────┬──────────┘      └─────────────────┘
                     │
      ┌──────────────┴─────────────┐         ┌─────────────────┐
      │                            │         │   ReceiptToken  │
┌─────▼─────┐             ┌────────▼───────┐ │                 │
│HoldingMana│◄────────────┤ StrategyManager│◄──────────────────┤
│   ger     │             └────────┬───────┘ │                 │
└─────┬─────┘                      │         └─────────────────┘
      │                            │               ▲
      │  ┌───────────────────┐     │               │
      └─►│      Holding      │     │       ┌───────┴───────┐
         └───────────────────┘     └─────►│ReceiptTokenFact│
                                           └───────────────┘

      ┌───────────────────┐
      │      Staker       │
      │                   │
      └───────────────────┘

## Clone & Re-org

### 使用 Clones.cloneDeterministic 创建新的 StakerLight 合约实例
采用克隆模式的主要原因如下：

1. 1.
   节省 Gas 成本 ：克隆合约不会复制原始合约的字节码，只是创建一个指向原始实现的引用，显著降低部署多个类似合约的 Gas 消耗。
2. 2.
   确定性地址 ：使用 cloneDeterministic 可以创建具有可预测地址的合约，通过 salt 参数（此处使用 msg.sender 的地址转换）确保可预测性，这对于需要在部署前知道地址的场景非常有用。
3. 3.
   代码复用与维护 ：克隆合约共享相同的代码逻辑，但拥有独立的存储空间，便于维护和更新。

### clone & cloneDeterministic 及 为什么 CREATE2 可以抗 Re-org

Clones.clone -> `CREATE`
Clones.cloneDeterministic -> `CREATE2`

* `CREATE`：合约地址 = `keccak256(sender, nonce)`
  → nonce 会随区块顺序/re-org 改变。

* `CREATE2`：合约地址 = `keccak256(0xff ++ sender ++ salt ++ init_code)`
  → 跟 nonce 无关，所以 re-org 后依然是 **同一个地址**。


### re-org（回滚后区块重排

**Re-org（Reorganization，链重组）**
就是当区块链发现有更长的链出现时，会 **回滚** 当前的区块，然后切换到更长的链。

例子：

1. 你看到的链：

   ```
   A → B1 → C1
   ```

   你的交易 T 在 C1 里。

2. 突然另一条链冒出来：

   ```
   A → B2 → C2 → D2
   ```

   这条链更长，所以全网切换过去。

3. 结果：

   * 链重组：C1 回滚，交易 T 消失。
   * 新链是：`A → B2 → C2 → D2`。

---

### Re-org 的影响

* **交易丢失**：未被包含到新链中的交易会“消失”，需要重新打包。
* **nonce 改变**：如果交易或合约部署依赖于 nonce（比如 `CREATE` 的合约地址），re-org 后 nonce 可能变化，导致：

🔹 重组期间的“短暂不一致”

* 在 re-org 发生前，某个分支（比如 B1 分支）可能被认为是“主链”。
* 在这个分支里，你的合约地址可能是 `0xAAA...`。
* 外部协议/用户可能已经 **与这个地址交互过**（例如发送资金或调用函数）。
* 当 re-org 发生后，这个分支被丢弃，链上真正的主链合约地址变成了 `0xBBB...`。
* **结果**：那笔交互“消失”，但资金可能已经转出，或者 off-chain 系统（前端、预言机、indexer）缓存了错误的合约地址。

## EIP-7702 - "合约账户发起交易"
it should be noted that the check disallowing a contract from creating a holding with msg.sender !=
tx.origin is obsolete due to EIP-7702.

          
## 针对系统中跨合约重入风险的架构改进建议：

@audit-high N Cross contract reentrancy during swaps allows an attacker to double account collateral

1. **问题分析**：
   - 指出跨合约重入风险在当前系统中似乎是一个普遍问题，因为系统被拆分为多个用户可以直接交互的独立合约
   - 传统的重入保护（reentrancy guards）在这种架构下效果有限

2. **架构改进建议**：
   - 建议限制公开可调用函数到一个单一的'网关'或'路由器'合约
   - 所有用户交互都必须通过这个网关合约进行，然后由它转发到其他系统合约
   - 这个网关合约必须实现非重入保护机制，作为系统的第一道防线

3. **具体应用场景**：
   - 举例说明：用户想投资某个策略时，必须调用网关合约，而非直接调用策略合约
   - 网关合约激活重入保护后，可防止攻击者在交换资产过程中（如本案例中的swap操作）进行额外的系统交互（如添加抵押品）

这一建议的核心是通过集中式的网关设计，将重入保护机制统一应用于所有用户入口点，从而更有效地防范跨合约重入攻击，而不是依赖于每个独立合约各自实现的重入保护。

## Pendle V2 pool/market

### SY 和 PT YT 

Pendle 的基本流程是：

1. **用户存入底层资产（underlying yield token）**

   * 例如：stETH、aUSDC、GLP 等。

2. **协议把它包一层 → SY (Standardized Yield)**

   * 作用：统一接口，不管你是 Lido staking token、Aave aToken，Pendle 都用 SY 封装，方便统一处理。

3. **SY 再被拆分成两部分：**

   * **PT (Principal Token)**

     * 代表“本金”，到期（maturity）之后，你可以用它换回 1:1 的 SY（进而换回底层资产）。
     * PT 是一个有时间价值的“债券”。
   * **YT (Yield Token)**

     * 代表“未来收益”，持有期间你能领到底层资产产生的利息/奖励，直到到期为止。

   - 你有 100 SY-stETH，有效期 1 年。
   - 你存进去 Pendle：
   - 得到 100 PT-stETH（到期后能换回 100 stETH 本金）。
   - 同时得到 100 YT-stETH（未来 1 年的质押收益）。

在 Pendle 的 AMM 设计里：

* 市场池子交易的是 **PT + SY**，
* YT 不进池子，单独交易。
  👉 这就是 Pendle V2 的核心结构。

---
### Attack Scenario:

1. **攻击者单边向 Pendle 池注入大量 PT（本金代币）。**
   *原因：先制造池子里 PT 过剩、PT\:SY 比例偏高的初始状态。*

2. **攻击者开一个仓位/持有资金，准备利用策略合约触发后续操作。**
   *原因：需要资金和后续交互能力，让策略合约替他完成“接盘”动作。*

3. **Jigsaw 的策略合约用抵押品把资金换成 SY 并调用 `addLiquiditySingleToken(SY)`。**
   *原因：该操作会用 SY 在池里买入 PT，再把买到的 PT 与剩余 SY 一起铸成 LP。*

4. **策略合约买到的 PT 恰好就是攻击者之前塞进去的 PT（攻击者被“卖掉”），池表面看似平衡。**
   *原因：攻击者把 PT 变现给策略合约，自己不亏且获得 LP/份额。*

5. **重复第1–4 步若干次，攻击者逐步控制池子大比例的流动性份额。**
   *原因：扩大对池子的控制，使后续撤回或清算操作受制于池子比例保护。*

6. **攻击者利用其控制的 LP 作为抵押，向协议借出大量稳定币（放贷/借款）。**
   *原因：把可用借贷能力变成即时可提走的收益，形成债务给协议。*

7. **当需要清算／撤回时，清算逻辑会尝试 `removeLiquiditySingleToken` 把 LP 换回 SY 或底层资产。**
   *原因：这是正常清算/赎回 LP 得到可售资产以偿还债务的流程。*

8. **因 LP 底层几乎为 PT，赎回时需要用大量 PT 换回 SY，触发 Pendle 的 `MarketProportionTooHigh` 保护，交易直接 revert，清算失败。**
   *原因：池子被设计成在极端 PT\:SY 失衡时禁止这样的转换以保护市场连续性。*

9. **结果：该仓位变为“不可清算”（unliquidatable），攻击者已提走借到的稳定币，协议产生坏账。**
   *原因：无法通过常规清算回收抵押资产，债务无法被覆盖。*

10. **总体后果：协议出现大量坏账/损失，用户（如 jUSD 持有人）承担损失并且系统信任受损。**

---